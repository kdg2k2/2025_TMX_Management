<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;

class RenderTreeMapGoogleDriveFolders extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'app:render-tree-map-google-drive-folders';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Hi·ªÉn th·ªã s∆° ƒë·ªì c·∫•u tr√∫c th∆∞ m·ª•c Google Drive';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        // T·∫°o th∆∞ m·ª•c n·∫øu ch∆∞a t·ªìn t·∫°i
        $outputPath = public_path('uploads/render');
        if (!file_exists($outputPath)) {
            mkdir($outputPath, 0755, true);
        }

        // T√™n file v·ªõi timestamp
        $fileName = 'tree_structure_' . date('Y-m-d_H-i-s') . '.txt';
        $filePath = $outputPath . '/' . $fileName;

        // B·∫Øt ƒë·∫ßu output buffering ƒë·ªÉ l∆∞u k·∫øt qu·∫£
        ob_start();

        /**
         * S∆° ƒë·ªì c·∫•u tr√∫c th∆∞ m·ª•c h·ªá th·ªëng
         * M√¥ t·∫£: C·∫•u tr√∫c t·ªï ch·ª©c th∆∞ m·ª•c cho h·ªá th·ªëng qu·∫£n l√Ω h·ª£p ƒë·ªìng, nh√¢n s·ª± v√† ·∫•n ph·∫©m khoa h·ªçc
         */
        $cauTrucThuMuc = [
            'Drive' => [
                'description' => 'Th∆∞ m·ª•c g·ªëc c·ªßa h·ªá th·ªëng',
                'children' => [
                    'Project' => [
                        'description' => 'Th∆∞ m·ª•c d·ª± √°n',
                        'children' => [
                            '{YYYY}' => [
                                'description' => 'Th∆∞ m·ª•c nƒÉm (v√≠ d·ª•: 2024, 2025)',
                                'children' => [
                                    '{TenTomTatHD}' => [
                                        'description' => 'Th∆∞ m·ª•c h·ª£p ƒë·ªìng (t√™n t√≥m t·∫Øt kh√¥ng d·∫•u, vi·∫øt li·ªÅn)',
                                        'note' => 'T·ª± ƒë·ªông t·∫°o khi th√™m h·ª£p ƒë·ªìng m·ªõi',
                                        'children' => [
                                            'Contracts' => [
                                                'description' => 'L∆∞u file scan/word h·ª£p ƒë·ªìng, BBTT, BBNT, BBTL',
                                                'note' => 'Qu·∫£n tr·ªã file ScanHD + ph·∫ßn HD/BBNT/BBTL',
                                                'children' => []
                                            ],
                                            'ProposalEstimateBudget' => [
                                                'description' => 'H·ªì s∆° th·∫ßu',
                                                'note' => 'HSMT (H·ªì s∆° m·ªùi th·∫ßu), HSCB (H·ªì s∆° ch√†o gi√°), HSNT (H·ªì s∆° nh√† th·∫ßu)',
                                                'children' => []
                                            ],
                                            'Disbursement' => [
                                                'description' => 'File excel ph√¢n b·ªï',
                                                'children' => []
                                            ],
                                            'Products' => [
                                                'description' => 'S·∫£n ph·∫©m d·ª± √°n',
                                                'children' => [
                                                    '1.MainProducts' => [
                                                        'description' => 'S·∫£n ph·∫©m ch√≠nh',
                                                        'children' => []
                                                    ],
                                                    '2.IntermediaProducts' => [
                                                        'description' => 'S·∫£n ph·∫©m trung gian',
                                                        'children' => []
                                                    ],
                                                    '3.Documentary_Decisions' => [
                                                        'description' => 'VƒÉn b·∫£n quy·∫øt ƒë·ªãnh',
                                                        'children' => []
                                                    ],
                                                    'z.DataReferences' => [
                                                        'description' => 'D·ªØ li·ªáu tham kh·∫£o',
                                                        'children' => []
                                                    ]
                                                ]
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ],
                    'NhanSu' => [
                        'description' => 'Th∆∞ m·ª•c qu·∫£n l√Ω th√¥ng tin nh√¢n s·ª± (ph·ª•c v·ª• ƒë·∫•u th·∫ßu)',
                        'note' => 'S·ª≠ d·ª•ng chung d·ªØ li·ªáu v·ªõi h·ªá th·ªëng IFEE',
                        'children' => [
                            'NhanSu_VST' => [
                                'description' => 'Nh√¢n s·ª± VST',
                                'children' => [
                                    '{HoVaTen}' => [
                                        'description' => 'Th∆∞ m·ª•c c√° nh√¢n (t√™n nh√¢n s·ª±)',
                                        'note' => 'T·ª± ƒë·ªông t·∫°o khi b·ªï sung nh√¢n s·ª± t·ª´ h·ªá th·ªëng IFEE',
                                        'children' => [
                                            'FileScan' => [
                                                'description' => 'C√°c file scan t√†i li·ªáu c√° nh√¢n',
                                                'children' => []
                                            ]
                                        ]
                                    ]
                                ]
                            ],
                            'NhanSu_DHLN' => [
                                'description' => 'Nh√¢n s·ª± ƒêHLN',
                                'children' => [
                                    '{HoVaTen}' => [
                                        'description' => 'Th∆∞ m·ª•c c√° nh√¢n (t√™n nh√¢n s·ª±)',
                                        'note' => 'T·ª± ƒë·ªông t·∫°o khi b·ªï sung nh√¢n s·ª± t·ª´ h·ªá th·ªëng IFEE',
                                        'children' => [
                                            'FileScan' => [
                                                'description' => 'C√°c file scan t√†i li·ªáu c√° nh√¢n',
                                                'children' => []
                                            ]
                                        ]
                                    ]
                                ]
                            ],
                            'NhanSu_Khac' => [
                                'description' => 'Nh√¢n s·ª± kh√°c',
                                'children' => [
                                    '{HoVaTen}' => [
                                        'description' => 'Th∆∞ m·ª•c c√° nh√¢n (t√™n nh√¢n s·ª±)',
                                        'note' => 'T·ª± ƒë·ªông t·∫°o khi b·ªï sung nh√¢n s·ª± t·ª´ h·ªá th·ªëng IFEE',
                                        'children' => [
                                            'FileScan' => [
                                                'description' => 'C√°c file scan t√†i li·ªáu c√° nh√¢n',
                                                'children' => []
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ],
                    'AnPhamKHCN' => [
                        'description' => '·∫§n ph·∫©m khoa h·ªçc c√¥ng ngh·ªá',
                        'children' => [
                            '{YYYY}' => [
                                'description' => 'Th∆∞ m·ª•c nƒÉm (v√≠ d·ª•: 2024, 2025)',
                                'children' => [
                                    'FileScanAnPham' => [
                                        'description' => 'File scan ·∫•n ph·∫©m c·ª• th·ªÉ',
                                        'children' => []
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            ]
        ];

        /**
         * H√†m in s∆° ƒë·ªì c√¢y (d·∫°ng text) v·ªõi ƒë∆∞·ªùng k·∫ª r√µ r√†ng
         */
        function inSoDoThumbuc($array, $level = 0, $prefix = '', $isLast = true)
        {
            $items = [];
            foreach ($array as $key => $value) {
                // B·ªè qua key 'description', 'note', 'children'
                if (in_array($key, ['description', 'note', 'children'])) {
                    continue;
                }
                $items[$key] = $value;
            }

            $totalItems = count($items);
            $currentIndex = 0;

            foreach ($items as $key => $value) {
                $currentIndex++;
                $isLastItem = ($currentIndex === $totalItems);

                // T·∫°o connector v√† prefix cho d√≤ng hi·ªán t·∫°i
                if ($level === 0) {
                    $connector = 'üìÅ ';
                    $childPrefix = '';
                } else {
                    $connector = ($isLastItem ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ') . 'üìÅ ';
                    $childPrefix = $prefix . ($isLastItem ? '    ' : '‚îÇ   ');
                }

                // In d√≤ng hi·ªán t·∫°i
                echo $prefix . $connector . $key;

                // In m√¥ t·∫£ n·∫øu c√≥
                if (isset($value['description'])) {
                    echo ' (' . $value['description'] . ')';
                }

                // In ghi ch√∫ n·∫øu c√≥
                if (isset($value['note'])) {
                    echo ' [' . $value['note'] . ']';
                }

                echo PHP_EOL;

                // ƒê·ªá quy in c√°c th∆∞ m·ª•c con
                if (isset($value['children']) && is_array($value['children']) && !empty($value['children'])) {
                    inSoDoThumbuc($value['children'], $level + 1, $childPrefix, $isLastItem);
                }
            }
        }

        /**
         * H√†m l·∫•y ƒë∆∞·ªùng d·∫´n ƒë·∫ßy ƒë·ªß c·ªßa m·ªôt th∆∞ m·ª•c
         */
        function layDuongDan($array, $target, $currentPath = '')
        {
            foreach ($array as $key => $value) {
                if (in_array($key, ['description', 'note', 'children'])) {
                    continue;
                }

                $newPath = $currentPath . '/' . $key;

                if ($key === $target) {
                    return $newPath;
                }

                if (isset($value['children']) && is_array($value['children'])) {
                    $result = layDuongDan($value['children'], $target, $newPath);
                    if ($result) {
                        return $result;
                    }
                }
            }

            return null;
        }

        // Xu·∫•t c·∫•u tr√∫c
        echo '=== S∆† ƒê·ªí C·∫§U TR√öC TH∆Ø M·ª§C H·ªÜ TH·ªêNG ===' . PHP_EOL . PHP_EOL;
        inSoDoThumbuc($cauTrucThuMuc);

        echo PHP_EOL . '=== V√ç D·ª§ ƒê∆Ø·ªúNG D·∫™N ===' . PHP_EOL;
        echo 'H·ª£p ƒë·ªìng: ' . layDuongDan($cauTrucThuMuc, 'Contracts') . PHP_EOL;
        echo 'Nh√¢n s·ª± VST: ' . layDuongDan($cauTrucThuMuc, 'NhanSu_VST') . PHP_EOL;
        echo '·∫§n ph·∫©m KHCN: ' . layDuongDan($cauTrucThuMuc, 'AnPhamKHCN') . PHP_EOL;

        // L·∫•y n·ªôi dung t·ª´ output buffer
        $content = ob_get_clean();

        // L∆∞u v√†o file
        file_put_contents($filePath, $content);

        // Hi·ªÉn th·ªã n·ªôi dung ra console
        echo $content;

        // Th√¥ng b√°o cho user
        echo PHP_EOL . '=== TH√îNG B√ÅO ===' . PHP_EOL;
        echo '‚úÖ ƒê√£ l∆∞u s∆° ƒë·ªì v√†o file: ' . $filePath . PHP_EOL;
        echo 'üìÇ ƒê∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi: /uploads/render/' . $fileName . PHP_EOL;
        echo 'üåê URL: ' . url('uploads/render/' . $fileName) . PHP_EOL;

        $this->info('Command executed successfully!');
    }
}
